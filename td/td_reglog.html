<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mise en oeuvre de la régression logistique avec =Python= et =statsmodels=</title>
<meta name="author" content="Roland Donat" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs/Charte_graphique/IUT/ubs_iut_vannes.css" />
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs-lpmds-python/custom.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Mise en oeuvre de la régression logistique avec <code>Python</code> et <code>statsmodels</code></h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table des matières</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3b62565">1. Contexte</a></li>
<li><a href="#orga322cc3">2. Préparation des données</a></li>
<li><a href="#orgbb53afa">3. Modélisation</a>
<ul>
<li><a href="#orgf91054e">3.1. Problématique</a></li>
<li><a href="#orgabb38ab">3.2. Préparation de la variable cible</a></li>
<li><a href="#org80730d5">3.3. Modèle \(\mathcal{M}_{0}\) : \(Y \sim \text{logit}\) (modèle trivial)</a></li>
<li><a href="#org7788a8d">3.4. Modèle \(\mathcal{M}_{1}\) : \(Y | X_{1} \sim \text{logit}\), \(X_{1} =\) <code>HSHT_M3</code></a></li>
<li><a href="#orgc2d5dc8">3.5. Modèle \(\mathcal{M}_{2}\) : \(Y | X_{1}, X_{2}, X_{3} \sim \text{logit}\), \(X_{1} =\) <code>HSHT_M3</code>, \(X_{2} =\) <code>ASHT_M3</code>, \(X_{3} =\) <code>phase</code></a></li>
</ul>
</li>
<li><a href="#orgd6fdea8">4. Évaluation des performances</a>
<ul>
<li><a href="#orgb749fe3">4.1. Données d'apprentissage et de test</a></li>
<li><a href="#orgbfcc020">4.2. Évaluation du modèle \(\mathcal{M}_{1}\)</a></li>
<li><a href="#orge9b0d02">4.3. Évaluation du modèle \(\mathcal{M}_{2}\)</a></li>
</ul>
</li>
<li><a href="#org2ccc909">5. Pistes pour aller plus loin</a></li>
</ul>
</div>
</div>






<div id="org7b93260" class="figure">
<p><img src="https://miro.medium.com/max/1000/1*x7P7gqjo8k2_bj2rTQWAfg.jpeg" alt="1*x7P7gqjo8k2_bj2rTQWAfg.jpeg" />
</p>
<p><span class="figure-number">Figure&nbsp;1&nbsp;: </span>Original comic by <a href="https://www.instagram.com/sandserifcomics/">sandserif</a></p>
</div>


<div id="outline-container-org3b62565" class="outline-2">
<h2 id="org3b62565"><span class="section-number-2">1.</span> Contexte</h2>
<div class="outline-text-2" id="text-1">
<p>
Dans cet ultime TD du module <code>Python</code>, nous allons mettre en oeuvre la méthode de régression
logistique afin prévoir le nombre de buts d'une rencontre de football. Nous reprendrons les données
du TD précédent et nous simplifierons donc la problématique en cherchant à pronostiquer si le nombre de buts d'une rencontre
est inférieur ou supérieur à 2.5 buts.
</p>

<p>
Ce problème s'apparente donc à un problème de classification supervisée dans lequel nous allons
entraîner un modèle statistique à partir de données contenant à la fois le nombre de buts de chaque rencontre
et des caractéristiques permettant de l'expliquer.
</p>

<p>
<b>Rappels :</b>
</p>
<ul class="org-ul">
<li>Créez un <i>notebook</i> dans le lequel vous allez écrire, exécuter et documenter votre code <code>Python</code>.</li>
<li>Prenez le temps de bien présenter et bien rédiger votre <i>notebook</i>.</li>
</ul>
</div>
</div>


<div id="outline-container-orga322cc3" class="outline-2">
<h2 id="orga322cc3"><span class="section-number-2">2.</span> Préparation des données</h2>
<div class="outline-text-2" id="text-2">
<p>
Nous reprenons les données utilisées dans le <a href="https://roland-donat.github.io/ubs-lpmds-python/td/td_decision.html">TD de Modélisation décisionnelles</a>, à savoir :
</p>
<ul class="org-ul">
<li>un historique de rencontre référencé par <code>fixtures</code> ;</li>
<li>un historique de cotes référencé par <code>odds</code>.</li>
</ul>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Charger les données historiques dans votre environnement :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> pandas <span style="color: #F0DFAF; font-weight: bold;">as</span> pd

<span style="color: #DFAF8F;">fixtures_url</span> = <span style="color: #CC9393;">"https://roland-donat.github.io/ubs-lpmds-python/td/data/fixtures_indics_all.csv.bz2"</span>
<span style="color: #DFAF8F;">fixtures_df</span> = pd.read_csv(fixtures_url, sep=<span style="color: #CC9393;">";"</span>, compression=<span style="color: #CC9393;">"bz2"</span>)

<span style="color: #DFAF8F;">col_cats</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"RHT"</span>, <span style="color: #CC9393;">"RFT"</span>]
<span style="color: #F0DFAF; font-weight: bold;">for</span> col <span style="color: #F0DFAF; font-weight: bold;">in</span> col_cats:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> <span style="color: #DFAF8F;">fixtures_df</span>[col] = fixtures_df[col].astype(<span style="color: #CC9393;">"category"</span>)

<span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"Date"</span>] = fixtures_df[<span style="color: #CC9393;">"Date"</span>].astype(<span style="color: #CC9393;">"datetime64[ns]"</span>)

<span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"NGFT"</span>] = fixtures_df[<span style="color: #CC9393;">"HGFT"</span>] + fixtures_df[<span style="color: #CC9393;">"AGFT"</span>]
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Discr&#233;tisation de la variable donnant le nombre de buts</span>
<span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"NGFTd"</span>] = pd.cut(fixtures_df[<span style="color: #CC9393;">"NGFT"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> bins=[-<span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>), 2.5, <span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>)],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> labels=[<span style="color: #CC9393;">"&lt;2.5"</span>, <span style="color: #CC9393;">"&gt;2.5"</span>])
</pre>
</div></li>

<li>Discrétiser la variable <code>HRND</code> (numéro du match de la saison pour l'équipe à domicile)
en quatre intervalles \(]0, 10], ]10, 20], ]20, 30], ]30, \infty[\). Labelliser ces intervalles
<code>Q1</code>, <code>Q2</code>, <code>Q3</code> et <code>Q4</code> de manière à indiquer les quatre parties d'une saison. Le résultat de la
discrétisation de la variable <code>HRND</code> est à stocker dans une nouvelle
variable appelée <code>phase</code>.</li>
<li><p>
Charger les données de cotes :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">odds_url</span> = <span style="color: #CC9393;">"https://roland-donat.github.io/ubs-lpmds-python/td/data/odds_bis.csv.bz2"</span>
<span style="color: #DFAF8F;">odds_df</span> = pd.read_csv(odds_url, sep=<span style="color: #CC9393;">";"</span>, compression=<span style="color: #CC9393;">"bz2"</span>)

<span style="color: #DFAF8F;">col_cats</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"NGFT2.5"</span>]
<span style="color: #F0DFAF; font-weight: bold;">for</span> col <span style="color: #F0DFAF; font-weight: bold;">in</span> col_cats:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> <span style="color: #DFAF8F;">odds_df</span>[col] = odds_df[col].astype(<span style="color: #CC9393;">"category"</span>)

<span style="color: #DFAF8F;">odds_df</span>[<span style="color: #CC9393;">"Date"</span>] = odds_df[<span style="color: #CC9393;">"Date"</span>].astype(<span style="color: #CC9393;">"datetime64[ns]"</span>)

<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Renommage de la variable "NGFT2.5" en "NGFTd" pour &#234;tre en coh&#233;rence</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">avec les donn&#233;es fixtures</span>
odds_df.rename(columns={<span style="color: #CC9393;">"NGFT2.5"</span>: <span style="color: #CC9393;">"NGFTd"</span>}, inplace=<span style="color: #BFEBBF;">True</span>)
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgbb53afa" class="outline-2">
<h2 id="orgbb53afa"><span class="section-number-2">3.</span> Modélisation</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgf91054e" class="outline-3">
<h3 id="orgf91054e"><span class="section-number-3">3.1.</span> Problématique</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Nous cherchons à pronostiquer si le nombre total des buts
inscrits lors d'une rencontre est inférieur (ou supérieur) à 2.5 buts.
</p>

<p>
D'un point de vue probabiliste, on note \(Y\) la variable aléatoire représentant le nombre de
buts inscrit sur une rencontre discrétisée au seuil de 2.5 buts (c'est-à-dire la variable <code>NGFT2.5d</code>
dans les données <code>fixtures</code>). Il s'agit donc d'une variable binaire ayant pour valeurs <code>&lt;2.5</code> ou
<code>&gt;2.5</code>. 
</p>

<p>
La variable \(Y\) est appelée variable cible ou variable à expliquer du problème
décisionnel. L'objectif est alors de prévoir/pronostiquer les valeurs de la variable cible à partir 
d'observations de variables disponibles. Ces variables observées sont appelées variables
explicatives.
</p>

<p>
Formellement, notre problème de pronostic revient alors à estimer la probabilité
</p>
\begin{equation}
\label{orgffb9e78}
P(Y = \text{>2.5} | X_{1} = x_{1}, \ldots, X_{n} = x_{n}),
\end{equation}
<p>
où :
</p>
<ul class="org-ul">
<li>\(x_{1}, \ldots, x_{n}\) sont des observations des variables explicatives \(X_{1}, \ldots, X_{n}\) que
nous avons choisi d'utiliser dans nos pronostics.</li>
<li>La modalité <code>&gt;2.5</code> a été choisi comme modalité de référence.</li>
</ul>

<p>
Dans ce TD, nous allons modéliser la loi conditionnelle \(Y | X_{1}, \ldots, X_{n}\) de la manière
suivante :
</p>
\begin{equation}
\label{org264a5f9}
P(Y = \text{>2.5} | X_{1} = x_{1}, \ldots, X_{n} = x_{n}) = \pi(x_{1},\ldots, x_{n}) = \frac{e^{\beta_{0} + x_{1}\beta_{1} + \ldots + x_{n}\beta_{n}}}{1 + e^{\beta_{0} + x_{1}\beta_{1} + \ldots + x_{n}\beta_{n}}}
\end{equation}
<p>
où les coefficients \(\beta_{0}, \ldots, \beta_{n} \in \mathbb{R}\) sont les paramètres du modèle logistique.
</p>

<p>
L'action d'estimer la valeur des paramètres \(\beta_{0}, \ldots, \beta_{n}\) à partir de données est
appelée régression logistique.  
</p>
</div>
</div>

<div id="outline-container-orgabb38ab" class="outline-3">
<h3 id="orgabb38ab"><span class="section-number-3">3.2.</span> Préparation de la variable cible</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Installer le module <code>patsy</code> avec la commande <code>!pip install patsy</code>, puis importer le module dans
votre environnement.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> patsy
</pre>
</div></li>
<li><p>
Le module <code>patsy</code> apporte des fonctionnalités de préparation de données pour la modélisation
statistique en utilisant une syntaxe
analogue aux <i>formulas</i> du logiciel <code>R</code>. La fonction <code>patsy.dmatrices</code> permet en particulier de créer une
matrice de variables d'expériences (<i>design matrix</i>) à partir d'une <i>formula</i>.
</p>

<p>
Observer et tenter de comprendre les sorties de la fonction <code>patsy.dmatrices</code> de l'exemple
suivant : 
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">NGFTd_df</span>, <span style="color: #DFAF8F;">features_test1_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   patsy.dmatrices(<span style="color: #CC9393;">"NGFTd ~ 1"</span>, data=fixtures_df, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)
</pre>
</div>

<p>
Faire de même dans les deux cas suivants :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">NGFTd_df</span>, <span style="color: #DFAF8F;">features_test2_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   patsy.dmatrices(<span style="color: #CC9393;">"NGFTd ~ 1 + HSHT_MA3"</span>, data=fixtures_df, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)

<span style="color: #DFAF8F;">NGFTd_df</span>, <span style="color: #DFAF8F;">features_test3_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   patsy.dmatrices(<span style="color: #CC9393;">"NGFTd ~ HSHT_MA3 + ASHT_MA3 + phase"</span>, data=fixtures_df, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)
</pre>
</div></li>
<li>Réaliser une analyse graphique bivariée de la variable cible par rapport aux variables
<code>HSHT_MA3</code>, <code>ASHT_MA3</code>, <code>phase</code>.</li>
</ol>
</div>
</div>
<div id="outline-container-org80730d5" class="outline-3">
<h3 id="org80730d5"><span class="section-number-3">3.3.</span> Modèle \(\mathcal{M}_{0}\) : \(Y \sim \text{logit}\) (modèle trivial)</h3>
<div class="outline-text-3" id="text-3-3">
<p>
On rappelle que le modèle trivial est le modèle consistant à ne tenir compte d'aucune variable
explicative pour expliquer la variable cible \(Y\).
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Rappeler l'expression mathématique de la modélisation réalisée.</li>
<li>Donner l'expression de l'estimation de \(\beta_{0}\), notée \(\hat{\beta}_{0}\), dans ce
modèle. Interpréter la valeur de ce paramètre.</li>
<li>Installer la librairie <code>statsmodels</code> qui donne accès à différentes techniques de modélisation
statistique. Commande : <code>!pip install statsmodels</code>.</li>
<li><p>
Importer le module <code>statsmodels.api</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> statsmodels.api <span style="color: #F0DFAF; font-weight: bold;">as</span> sm
</pre>
</div></li>
<li>Regarder l'aide de la fonction <code>Logit</code> du module <code>statsmodels.api</code>.</li>
<li>Préparer les données en utilisant la fonction <code>patsy.dmatrices</code>.</li>
<li><p>
Utiliser la fonction <code>Logit</code> pour entraîner votre modèle trivial et interpréter les résultats
obtenus.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">D&#233;claration du mod&#232;le</span>
<span style="color: #DFAF8F;">mod0</span> = sm.Logit(NGFTd_df[<span style="color: #CC9393;">"NGFTd[&gt;2.5]"</span>], features_mod0_df) 
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Apprentissage du mod&#232;le</span>
<span style="color: #DFAF8F;">mod0</span> = mod0.fit()
mod0.summary()
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-org7788a8d" class="outline-3">
<h3 id="org7788a8d"><span class="section-number-3">3.4.</span> Modèle \(\mathcal{M}_{1}\) : \(Y | X_{1} \sim \text{logit}\), \(X_{1} =\) <code>HSHT_M3</code></h3>
<div class="outline-text-3" id="text-3-4">
<p>
<b>Travail à réaliser :</b> 
</p>
<ol class="org-ol">
<li>Rappeler l'expression mathématique de la modélisation réalisée.</li>
<li>Préparer les données en utilisant la formule adéquate avec la fonction <code>patsy.dmatrices</code>.</li>
<li>Utiliser la fonction <code>Logit</code> pour entraîner le modèle.</li>
<li>Interpréter les caractéristiques du modèle.</li>
<li><p>
Calculer les probabilités <i>a posteriori</i> \(P(Y=\text{>2.5} | X_{1} = 0) = \pi_{1}(0)\),
\(P(Y=\text{>2.5} | X_{1} = 6) = \pi_{1}(6)\) et \(P(Y=\text{>2.5} | X_{1} = -10) = \pi_{1}(-10)\) dans le modèle
\(\mathcal{M}_{1}\) en utilisant la méthode <code>.predict</code> du modèle. Interpréter ces probabilités en français.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">features_mod1_ex_df</span> = patsy.dmatrix(<span style="color: #CC9393;">"HSHT_M3"</span>, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   pd.DataFrame({<span style="color: #CC9393;">"HSHT_M3"</span>: [0, 6, -10]}), 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)
<span style="color: #DFAF8F;">pi_mod1_ex</span> = mod1.predict(features_mod1_ex_df)
</pre>
</div></li>

<li>Calculer les probabilités <i>a posteriori</i> \(P(Y=\text{>2.5} | X_{1} =
   x_{1}) = \pi(x_{1})\) avec \(x_{1}\) variant de -50 à 50 dans le modèle
\(\mathcal{M}_{1}\).</li>
<li>Représenter graphiquement les probabilités de la question précédente et interpréter ce graphique.</li>
<li>Calculer le rapport de cotes (<i>odds ratio</i>) associé à la variable <code>HSHT_M3</code>.</li>
</ol>
</div>
</div>
<div id="outline-container-orgc2d5dc8" class="outline-3">
<h3 id="orgc2d5dc8"><span class="section-number-3">3.5.</span> Modèle \(\mathcal{M}_{2}\) : \(Y | X_{1}, X_{2}, X_{3} \sim \text{logit}\), \(X_{1} =\) <code>HSHT_M3</code>, \(X_{2} =\) <code>ASHT_M3</code>, \(X_{3} =\) <code>phase</code></h3>
<div class="outline-text-3" id="text-3-5">
<p>
<b>Travail à réaliser :</b> 
</p>
<ol class="org-ol">
<li>Rappeler l'expression mathématique de la modélisation réalisée.</li>
<li>Préparer les données en utilisant la formule adéquate avec la fonction <code>patsy.dmatrices</code>.</li>
<li>Utiliser la fonction <code>Logit</code> pour entraîner le modèle.</li>
<li>Interpréter les caractéristiques du modèle.</li>
<li><p>
Calculer les probabilités <i>a posteriori</i> \(P(Y=\text{>2.5} | X_{1}=0, X_{2}=0, X_{3}=\text{Q1}) = \pi_{2}(0, 0, \text{Q1})\),
\(P(Y=\text{>2.5} | X_{1} = 6, X_{2} = 2, X_{3}=\text{Q4}) = \pi_{2}(6, 2, \text{Q4})\) et
\(P(Y=\text{>2.5} | X_{1}=2, X_{2} = 6, X_{3}=\text{Q4}) = \pi_{2}(2, 6, \text{Q4})\) dans le modèle
\(\mathcal{M}_{2}\) en utilisant la méthode <code>.predict</code> du modèle. Interpréter ces probabilités en français.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">features_raw_df</span> = pd.DataFrame({
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #CC9393;">"HSHT_M3"</span>: [0, 6, 2],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #CC9393;">"ASHT_M3"</span>: [0, 2, 6],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #CC9393;">"phase"</span>: [<span style="color: #CC9393;">"Q1"</span>, <span style="color: #CC9393;">"Q4"</span>, <span style="color: #CC9393;">"Q4"</span>]})
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">On renseigne la nature de la variable phase en pr&#233;cisant les modalit&#233;s possibles</span>
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Important pour utiliser dmatrix par la suite</span>
<span style="color: #DFAF8F;">features_raw_df</span>[<span style="color: #CC9393;">"phase"</span>] = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   features_raw_df[<span style="color: #CC9393;">"phase"</span>].astype(<span style="color: #CC9393;">"category"</span>)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .cat.set_categories(fixtures_df[<span style="color: #CC9393;">"phase"</span>].cat.categories)

<span style="color: #DFAF8F;">features_mod2_ex_df</span> = patsy.dmatrix(<span style="color: #CC9393;">"1 + HSHT_M3 + ASHT_M3 + phase"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   features_raw_df,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)
<span style="color: #DFAF8F;">pi_mod2_ex</span> = mod2.predict(features_mod2_ex_df)
</pre>
</div></li>
<li>Calculer les rapports de cotes du modèle.</li>
<li><p>
Créer une fonction <code>odds_ratio</code> prenant en argument un modèle et qui calcule un <code>DataFrame</code>
donnant pour chaque variable : l'<i>odds ratio</i>, l'intervalle de confiance à 5%, la <i>p-values</i> et un indicateur qui
vaut <code>True</code> si le paramètre est significatif au seuil de 5% et <code>False</code> sinon.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">odds_ratio</span>(model):
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Aide :</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">params = model.params</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">conf_df = model.conf_int()</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">pval = model.pvalues</span>

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">&#192; COMPL&#201;TER</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> or_df 
</pre>
</div>
<p>
Le résultat de l'exécution de la commande <code>odds_ratio(mod2)</code> est :
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-right">OR</th>
<th scope="col" class="org-right">2.5%</th>
<th scope="col" class="org-right">97.5%</th>
<th scope="col" class="org-right">pvalues</th>
<th scope="col" class="org-left">signif_5%</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Intercept</td>
<td class="org-right">0.598966</td>
<td class="org-right">0.539366</td>
<td class="org-right">0.665152</td>
<td class="org-right">9.27355e-22</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">phase[T.Q2]</td>
<td class="org-right">1.00474</td>
<td class="org-right">0.930679</td>
<td class="org-right">1.08469</td>
<td class="org-right">0.903674</td>
<td class="org-left">False</td>
</tr>

<tr>
<td class="org-left">phase[T.Q3]</td>
<td class="org-right">0.943084</td>
<td class="org-right">0.873411</td>
<td class="org-right">1.01831</td>
<td class="org-right">0.134523</td>
<td class="org-left">False</td>
</tr>

<tr>
<td class="org-left">phase[T.Q4]</td>
<td class="org-right">1.12016</td>
<td class="org-right">1.0304</td>
<td class="org-right">1.21774</td>
<td class="org-right">0.00775204</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">HSHT_MA3</td>
<td class="org-right">1.0814</td>
<td class="org-right">1.0651</td>
<td class="org-right">1.09795</td>
<td class="org-right">5.58938e-24</td>
<td class="org-left">True</td>
</tr>

<tr>
<td class="org-left">ASHT_MA3</td>
<td class="org-right">1.03039</td>
<td class="org-right">1.01538</td>
<td class="org-right">1.04563</td>
<td class="org-right">6.4041e-05</td>
<td class="org-left">True</td>
</tr>
</tbody>
</table></li>

<li><p>
Construire une fonction <code>or_visu</code>, prenant en argument un modèle de régression logistique,
permettant de visualiser les <i>odds ratios</i> et leur intervalle de 
confiance en utilisant les fonctions <code>odds_ratio</code> et <code>px.scatter</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #93E0E3;">or_visu</span>(model):

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Calcul des OR avec notre fonction odds_ratio</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">or_df</span> = odds_ratio(model)

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Calcul des deltas entre l'estimation des OR et les bornes des intervalles de confiance</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">or_df</span>[<span style="color: #CC9393;">"d2.5%"</span>] = or_df[<span style="color: #CC9393;">"OR"</span>] - or_df[<span style="color: #CC9393;">"2.5%"</span>]
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">or_df</span>[<span style="color: #CC9393;">"d97.5%"</span>] = or_df[<span style="color: #CC9393;">"97.5%"</span>] - or_df[<span style="color: #CC9393;">"OR"</span>]

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">model_name</span> = f<span style="color: #CC9393;">"{model.model.endog_names} ~ logit({', '.join(model.model.exog_names)})"</span>
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DFAF8F;">fig</span> = px.scatter(or_df,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>x=<span style="color: #CC9393;">"OR"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>y=or_df.index,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>color=<span style="color: #CC9393;">"signif_5%"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>error_x_minus=<span style="color: #CC9393;">"d2.5%"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>error_x=<span style="color: #CC9393;">"d97.5%"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>title=f<span style="color: #CC9393;">"Odds ratio du mod&#232;le {model_name}"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>labels={<span style="color: #CC9393;">"index"</span>: <span style="color: #CC9393;">"Variable"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span><span style="color: #CC9393;">"signif_5%"</span>: <span style="color: #CC9393;">"Significativit&#233; &#224; 5%"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span><span style="color: #CC9393;">"OR"</span>: <span style="color: #CC9393;">"Odds ratio"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>})

<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #F0DFAF; font-weight: bold;">return</span> fig

or_visu(mod2)
</pre>
</div>
<p>
Quelle(s) critique(s) peut-on formuler sur ce résultat visuel ?
</p></li>
</ol>
</div>
</div>
</div>


<div id="outline-container-orgd6fdea8" class="outline-2">
<h2 id="orgd6fdea8"><span class="section-number-2">4.</span> Évaluation des performances</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgb749fe3" class="outline-3">
<h3 id="orgb749fe3"><span class="section-number-3">4.1.</span> Données d'apprentissage et de test</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Pour évaluer nos différents modèles, nous mettons en oeuvre l'approche classique consistant à
séparer nos données en deux échantillons : 
</p>
<ol class="org-ol">
<li>un échantillon, dit d'<b>apprentissage</b>, servant à ajuster les paramètres d'un modèle ;</li>
<li>un échantillon, dit de <b>test</b>, sur lequel nous allons évaluer les performances prédictives du
modèle étudié.</li>
</ol>

<p>
La proportion entre données d'apprentissage et données de test est usuellement de 2/3, 1/3 mais tout
dépend en pratique de l'application considérée.  
</p>

<p>
<b>Notes :</b>
</p>
<ul class="org-ul">
<li>Si les données étudiées dépendent du temps (comme c'est le cas pour les pronostics
sportifs), il est important de veiller à ce que les données d'apprentissage soient bien
antérieures aux données de test.</li>
<li>Si les données sont quelconques, il est souvent pertinent de conserver la même proportion entre
les modalités de la variable cible dans les données d'apprentissage et de test.</li>
</ul>

<p>
<b>Travail à réaliser :</b> 
</p>
<ol class="org-ol">
<li><p>
Créer un échantillon d'apprentissage <code>fixtures_train_df</code> en prenant les rencontres ayant eu lieu
avant la saison <code>2019-2020</code> et en supprimant les matchs ayant au moins une variable manquante.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">idx_train</span> = fixtures_df[<span style="color: #CC9393;">"season_id"</span>].astype(<span style="color: #DCDCCC; font-weight: bold;">str</span>) &lt; <span style="color: #CC9393;">"2019-2020"</span>
<span style="color: #DFAF8F;">fixtures_train_df</span> = fixtures_df.loc[idx_train].dropna()
</pre>
</div></li>

<li>Créer l'échantillon de test <code>fixtures_test_df</code> en prenant le reste des données (en supprimant
également les matchs possédant des valeurs manquantes), à savoir les
matchs ayant eu lieu lors de la saison <code>2019-2020</code> et après.</li>
</ol>
</div>
</div>
<div id="outline-container-orgbfcc020" class="outline-3">
<h3 id="orgbfcc020"><span class="section-number-3">4.2.</span> Évaluation du modèle \(\mathcal{M}_{1}\)</h3>
<div class="outline-text-3" id="text-4-2">
<p>
L'objectif de cette section est d'appliquer l'approche apprentissage/test afin d'évaluer la
modélisation logistique de la loi \(Y | \text{HSHT_M3}\)
</p>

<p>
<b>Travail à réaliser :</b>
</p>

<ol class="org-ol">
<li><p>
Préparer les données d'apprentissage et de test en utilisant la formule adéquate avec la fonction
<code>patsy.dmatrices</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">mod1_formula_str</span> = <span style="color: #CC9393;">"NGFTd ~ 1 + HSHT_MA3"</span>

<span style="color: #DFAF8F;">NGFTd_train_df</span>, <span style="color: #DFAF8F;">features_mod1_train_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   patsy.dmatrices(mod1_formula_str, data=fixtures_train_df, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)

<span style="color: #DFAF8F;">NGFTd_test_df</span>, <span style="color: #DFAF8F;">features_mod1_test_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   patsy.dmatrices(mod1_formula_str, data=fixtures_test_df, 
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   return_type=<span style="color: #CC9393;">"dataframe"</span>)
</pre>
</div></li>

<li>Estimer les paramètres du modèle \(\mathcal{M}_{1}\) à partir des données d'apprentissage et
stocker l'objet modèle ainsi créé dans la variable <code>mod1_train</code>.</li>
<li><p>
Calculer la probabilité <i>a posteriori</i> de l'événement d'intérêt \(Y=\text{>2.5}\) à partir des
données de test.  
</p>
<div class="org-src-container">
<pre class="src src-python">fixtures_test_df[<span style="color: #CC9393;">"NGFTd[&gt;2.5]_mod1_pap"</span>] = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   mod1_train.predict(features_mod1_test_df)
</pre>
</div></li>

<li><p>
Pronostiquer la variable cible sur les données de test à partir des probabilités <i>a posteriori</i>
calculées précédemment en utilisant un seuil de décision \(\delta = 0.5\).
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">delta</span> = 0.5
<span style="color: #DFAF8F;">fixtures_test_df</span>[<span style="color: #CC9393;">"NGFTd_mod1_pred_50"</span>] = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   np.where(fixtures_test_df[<span style="color: #CC9393;">"NGFTd[&gt;2.5]_mod1_pap"</span>] &gt; delta, <span style="color: #CC9393;">"&gt;2.5"</span>, <span style="color: #CC9393;">"&lt;2.5"</span>)
</pre>
</div></li>

<li><p>
Calculer la matrice de confusion et le taux de bons pronostics obtenus. Cette matrice de
confusion apporte-t-elle des éléments pertinents quant à l'évaluation de notre modèle ?
</p>
<div class="org-src-container">
<pre class="src src-python">pd.crosstab(fixtures_test_df[<span style="color: #CC9393;">"NGFTd"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_df[<span style="color: #CC9393;">"NGFTd_mod1_pred_50"</span>])
</pre>
</div></li>

<li><p>
Nous allons à présent évaluer les pronostics réalisés par le modèle en utilisant les cotes. Pour
ce faire, créer tout d'abord un nouveau <code>DataFrame</code> <code>fixtures_test_odds_df</code> en effectuant une
jointure entre les 
<code>DataFrames</code> <code>fixtures_test_df</code> et <code>odds_df</code> afin d'obtenir la cote associée aux
valeurs de la variable <code>NGFTd</code> pour chacune des rencontres :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">var_odds_id</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"Date"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"NGFTd"</span>]

<span style="color: #DFAF8F;">fixtures_test_odds_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_df.set_index(var_odds_id)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .join(odds_df.set_index(var_odds_id))\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .dropna()\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .reset_index()
</pre>
</div></li>

<li><p>
Ajouter une colonne <code>score_mod1_50</code> au <code>DataFrame</code> <code>fixtures_test_odds_df</code> contenant, pour
chaque rencontre :
</p>
<ul class="org-ul">
<li>la valeur de la colonne <code>odds</code> - 1 si le pronostic du modèle est correct ;</li>
<li>-1 sinon.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">idx_pronostic_ok</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_odds_df[<span style="color: #CC9393;">"NGFTd"</span>] == fixtures_test_odds_df[<span style="color: #CC9393;">"NGFTd_mod1_pred_50"</span>]
<span style="color: #DFAF8F;">fixtures_test_odds_df</span>[<span style="color: #CC9393;">"score_mod1_pred_50"</span>] = fixtures_test_odds_df[<span style="color: #CC9393;">"odds"</span>] - 1
<span style="color: #DFAF8F;">fixtures_test_odds_df.loc</span>[~idx_pronostic_ok, <span style="color: #CC9393;">"score_mod1_pred_50"</span>] = -1
</pre>
</div></li>

<li><p>
En déduire la performance du modèle \(\mathcal{M}_{1}\) évaluée sur les données de
test considérée. Interpréter le résultat obtenu ?
</p>
<div class="org-src-container">
<pre class="src src-python">fixtures_test_odds_df[<span style="color: #CC9393;">"score_mod1_pred_50"</span>].<span style="color: #DCDCCC; font-weight: bold;">sum</span>()
</pre>
</div></li>

<li><p>
Représenter graphiquement la performance moyenne du modèle par saison et
par championnat. Question : À quoi sert l'argument <code>observed</code> dans la mathode <code>groupby</code> ?
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">mod1_pred_50_grp_avg</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_odds_df.groupby([<span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"league_id"</span>], observed=<span style="color: #BFEBBF;">True</span>)[<span style="color: #CC9393;">"score_mod1_pred_50"</span>].mean()

<span style="color: #DFAF8F;">fig</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   px.bar(mod1_pred_50_grp_avg.reset_index(),
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  x=<span style="color: #CC9393;">"season_id"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  y=<span style="color: #CC9393;">"score_mod1_pred_50"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  color=<span style="color: #CC9393;">"league_id"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  title=<span style="color: #CC9393;">"Performances du mod&#232;le M1"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  labels={<span style="color: #CC9393;">"season_id"</span>: <span style="color: #CC9393;">"Saison"</span>, <span style="color: #CC9393;">"score_mod1_pred_50"</span>: <span style="color: #CC9393;">"Score M1 delta 0.5"</span>, <span style="color: #CC9393;">"league_id"</span>: <span style="color: #CC9393;">"Championnat"</span>},
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  barmode=<span style="color: #CC9393;">"group"</span>)
fig
</pre>
</div></li>

<li>Selon vous, comment pourrait-on améliorer la performance de nos pronostics ?</li>
</ol>
</div>
</div>


<div id="outline-container-orge9b0d02" class="outline-3">
<h3 id="orge9b0d02"><span class="section-number-3">4.3.</span> Évaluation du modèle \(\mathcal{M}_{2}\)</h3>
<div class="outline-text-3" id="text-4-3">
<p>
L'objectif de cette section est d'appliquer l'approche apprentissage/test afin d'évaluer la
modélisation logistique de la loi \(Y | \text{HSHT_M3}, \text{ASHT_M3}, \text{phase}\).
</p>

<p>
<b>Travail à réaliser :</b>
</p>

<ol class="org-ol">
<li>Reprendre le travail de la section précédente afin de l'appliquer au modèle \(\mathcal{M}_{2}\), à
savoir :
<ol class="org-ol">
<li>Préparation des données avec <code>patsy</code>.</li>
<li>Estimation des paramètres à partir des données d'apprentissage.</li>
<li>Calculer des probabilités <i>a posteriori</i> de l'événement d'intérêt sur les données de test.</li>
<li>Pronostiquer la variable cible avec un seuil de décision \(\delta = 0.5\).</li>
<li>Calculer pour information la matrice de confusion.</li>
<li>Évaluer la performance du modèle à partir des cotes.</li>
<li>Représenter graphiquement la performance moyenne du modèle par saison et par championnat.</li>
</ol></li>
<li>Comparer les performances obtenues avec le modèle $\mathcal{M}<sub>1</sub>.</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org2ccc909" class="outline-2">
<h2 id="org2ccc909"><span class="section-number-2">5.</span> Pistes pour aller plus loin</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Analyser les scores obtenus sur vos modèles en fonction du seuil de décision. Le seuil de 0.5
n'est vraisemblablement optimal.</li>
<li>Tenter d'identifier des situations où il semble plus pertinentes que d'autres de parier, penser
en particulier aux cas où la probabilité <i>a posteriori</i> de l'événement estimée par le modèle
est plus importante que la probabilité estimée par le bookmaker (cf. notion de <i>value bet</i>).</li>
<li>Ajuster votre mise en fonction la probabilité <i>a posteriori</i> de l'événement estimée par le
modèle.</li>
<li>Travailler sur les variables explicatives afin d'améliorer le pouvoir prédictif de vos
modèles.</li>
<li>Si vous trouvez un algorithme miracle, n'hésitez pas à en parler avec moi ;)</li>
</ul>
</div>
</div>
</div>
</body>
</html>
