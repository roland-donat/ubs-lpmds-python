<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Introduction à la modélisation décisionnelle avec =Python=</title>
<meta name="author" content="Roland Donat" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs/Charte_graphique/IUT/ubs_iut_vannes.css" />
<link rel="stylesheet" type="text/css" href="https://roland-donat.github.io/ubs-lpmds-python/custom.css" />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Introduction à la modélisation décisionnelle avec <code>Python</code></h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table des matières</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orge89669e">1. Contexte</a></li>
<li><a href="#orga1d1e5d">2. Données de matchs</a>
<ul>
<li><a href="#orgb45ffe0">2.1. Présentation des données</a></li>
<li><a href="#org4d6226e">2.2. Chargement des données</a></li>
<li><a href="#org3b57d91">2.3. Vérification des indicateurs glissants moyens</a></li>
</ul>
</li>
<li><a href="#sec:odds_df">3. Données de cotes</a>
<ul>
<li><a href="#org7782204">3.1. Rappels</a></li>
<li><a href="#org48c06ce">3.2. Présentation des données</a></li>
<li><a href="#org581a56a">3.3. Chargement des données</a></li>
</ul>
</li>
<li><a href="#org8a19b95">4. Modélisation décisionnelle</a>
<ul>
<li><a href="#orga204132">4.1. Généralité</a></li>
<li><a href="#org3c184c7">4.2. Modèle empirique <i>a priori</i></a></li>
<li><a href="#sec:model_emp_hsht_ma3d">4.3. Modèle empirique <code>HSHT_MA3</code></a></li>
</ul>
</li>
<li><a href="#org5b1eafd">5. Évaluation des performances</a>
<ul>
<li><a href="#orge1feaad">5.1. Données d'apprentissage et de test</a></li>
<li><a href="#orgffba23d">5.2. Apprentissage des modèles</a>
<ul>
<li><a href="#orgc4bf604">5.2.1. Modèle empirique <code>HSHT_MA3d</code></a></li>
<li><a href="#org789a31f">5.2.2. Modèle empirique <code>HSHT_ASHT_MA3d</code></a></li>
</ul>
</li>
<li><a href="#org2378ebd">5.3. Évaluation des modèles</a>
<ul>
<li><a href="#org6ddf959">5.3.1. Modèle empirique <code>HSHT_MA3d</code></a></li>
<li><a href="#orge8ef4d1">5.3.2. Modèle empirique <code>HSHT_ASHT_MA3d</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>






<div id="org6d02a3f" class="figure">
<p><img src="https://www.agent-x.com.au/wp-content/uploads/2011/06/Perfect-Programmer-dfe194b-e8d3b11-b960bd5.jpg" alt="Perfect-Programmer-dfe194b-e8d3b11-b960bd5.jpg" />
</p>
</div>


<div id="outline-container-orge89669e" class="outline-2">
<h2 id="orge89669e"><span class="section-number-2">1.</span> Contexte</h2>
<div class="outline-text-2" id="text-1">
<p>
Dans les TD précédents, nous avons pris connaissance de la librairie <code>Pandas</code> en explorant certaines
de ses fonctionnalités pour la manipulation des données sous <code>Python</code>. Nous avons également réalisé
des premières analyses descriptives graphiques avec la librairie <code>plotly.express</code>.
</p>

<p>
Rappelons que le fil rouge de nos TD est l'analyse réalisation de pronostics sur des matchs 
de football. Il s'agit donc à présent de se pencher sur cette notion de pronostic et de comprendre
en quoi l'analyse de données va nous être d'une aide précieuse.
</p>

<p>
Les objectifs de ce TD sont :
</p>
<ul class="org-ul">
<li>Approfondir ses compétences en traitement des données sous <code>Python</code>.</li>
<li>Construire vos premiers algorithmes de pronostics.</li>
<li>Développer une méthode d'évaluation des pronostics réalisés.</li>
<li>Chercher des idées pour améliorer vos premiers algorithmes.</li>
</ul>

<p>
<b>Rappels :</b>
</p>
<ul class="org-ul">
<li>Créez un <i>notebook</i> dans le lequel vous allez écrire, exécuter et documenter votre code <code>Python</code>.</li>
<li>Prenez le temps de bien présenter et bien rédiger votre <i>notebook</i>.</li>
</ul>
</div>
</div>

<div id="outline-container-orga1d1e5d" class="outline-2">
<h2 id="orga1d1e5d"><span class="section-number-2">2.</span> Données de matchs</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgb45ffe0" class="outline-3">
<h3 id="orgb45ffe0"><span class="section-number-3">2.1.</span> Présentation des données</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Comme dans les TD précédents, les données historiques de matchs, référencées dans la suite par données
 <code>fixtures</code>, contiennent un historique de matchs sur différents championnats. Le Tableau
 <a href="#org403e8d9">1</a> présente  une description succinctes des variables présentes.
</p>

<table id="org403e8d9" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Tableau 1 :</span> Définition des variables du jeu de données <code>fixtures</code>.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Colonne</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">league_id</td>
<td class="org-left">Identifiant du championnat</td>
</tr>

<tr>
<td class="org-left">season_id</td>
<td class="org-left">Identifiant de la saison</td>
</tr>

<tr>
<td class="org-left">Date</td>
<td class="org-left">Date du match au format %Y-%m-%d</td>
</tr>

<tr>
<td class="org-left">HTeam</td>
<td class="org-left">Équipe à domicile (ÉD)</td>
</tr>

<tr>
<td class="org-left">ATeam</td>
<td class="org-left">Équipe à l'extérieure (ÉE)</td>
</tr>

<tr>
<td class="org-left">HGHT</td>
<td class="org-left">Nombre de buts inscrit à la mi-temps (ÉD)</td>
</tr>

<tr>
<td class="org-left">AGHT</td>
<td class="org-left">Nombre de buts inscrit à la mi-temps (ÉE)</td>
</tr>

<tr>
<td class="org-left">HGFT</td>
<td class="org-left">Nombre de buts inscrit à la fin du match (ÉD)</td>
</tr>

<tr>
<td class="org-left">AGFT</td>
<td class="org-left">Nombre de buts inscrit à la fin du match (ÉE)</td>
</tr>

<tr>
<td class="org-left">RHT</td>
<td class="org-left">Résultat à la mi-temps (H = ED gagne, D = match nul, A = EE gagne)</td>
</tr>

<tr>
<td class="org-left">RFT</td>
<td class="org-left">Résultat à la fin du match (H = ED gagne, D = match nul, A = EE gagne)</td>
</tr>

<tr>
<td class="org-left">ARND</td>
<td class="org-left">Numéro de journée (ÉE)</td>
</tr>

<tr>
<td class="org-left">HRND</td>
<td class="org-left">Numéro de journée (ÉD)</td>
</tr>

<tr>
<td class="org-left">ASHT_MA3</td>
<td class="org-left">Nombre de tirs cadrés moyen sur les 3 derniers matchs (ÉE)</td>
</tr>

<tr>
<td class="org-left">HSHT_MA3</td>
<td class="org-left">Nombre de tirs cadrés moyen sur les 3 derniers matchs (ÉD)</td>
</tr>

<tr>
<td class="org-left">HSHT</td>
<td class="org-left">Nombre de tirs cadrés (ÉD)</td>
</tr>

<tr>
<td class="org-left">ASHT</td>
<td class="org-left">Nombre de tirs cadrés (ÉE)</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org4d6226e" class="outline-3">
<h3 id="org4d6226e"><span class="section-number-3">2.2.</span> Chargement des données</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Charger les données historiques dans votre environnement :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> pandas <span style="color: #F0DFAF; font-weight: bold;">as</span> pd

<span style="color: #DFAF8F;">fixtures_url</span> = <span style="color: #CC9393;">"https://roland-donat.github.io/ubs-lpmds-python/td/data/fixtures_indics_all.csv.bz2"</span>
<span style="color: #DFAF8F;">fixtures_df</span> = pd.read_csv(fixtures_url, sep=<span style="color: #CC9393;">";"</span>, compression=<span style="color: #CC9393;">"bz2"</span>)
</pre>
</div></li>

<li><p>
Réaliser les opérations de typage adéquates :
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">col_cats</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"RHT"</span>, <span style="color: #CC9393;">"RFT"</span>]
<span style="color: #F0DFAF; font-weight: bold;">for</span> col <span style="color: #F0DFAF; font-weight: bold;">in</span> col_cats:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> <span style="color: #DFAF8F;">fixtures_df</span>[col] = fixtures_df[col].astype(<span style="color: #CC9393;">"category"</span>)

<span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"Date"</span>] = fixtures_df[<span style="color: #CC9393;">"Date"</span>].astype(<span style="color: #CC9393;">"datetime64[ns]"</span>)
</pre>
</div></li>
</ol>
</div>
</div>


<div id="outline-container-org3b57d91" class="outline-3">
<h3 id="org3b57d91"><span class="section-number-3">2.3.</span> Vérification des indicateurs glissants moyens</h3>
<div class="outline-text-3" id="text-2-3">
<p>
La variable <code>HSHT_MA3</code> (resp. <code>ASHT_MA3</code>) représente le nombre de tirs cadrés moyens sur les trois
derniers matchs réalisé par l'équipe à domicile (resp. l'équipe à l'extérieur).
</p>

<p>
Pour calculer ces variables pour une équipe à une journée donnée, il faut faire la moyenne des tirs
cadrés de cette équipe sur les trois dernière journées passées.
</p>

<p>
Le Tableau <a href="#orga90cbd8">2</a> présente les données des 10 premiers matchs de Lorient sur la saison
2021-2022. 
</p>

<table id="orga90cbd8" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Tableau 2 :</span> Définition des variables du jeu de données <code>fixtures</code>.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Date</th>
<th scope="col" class="org-left">HTeam</th>
<th scope="col" class="org-left">ATeam</th>
<th scope="col" class="org-right">HRND</th>
<th scope="col" class="org-right">ARND</th>
<th scope="col" class="org-right">HGFT</th>
<th scope="col" class="org-right">AGFT</th>
<th scope="col" class="org-left">RFT</th>
<th scope="col" class="org-right">HSHT</th>
<th scope="col" class="org-right">ASHT</th>
<th scope="col" class="org-right">HSHT_MA3</th>
<th scope="col" class="org-right">ASHT_MA3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">2021-08-08 00:00:00</td>
<td class="org-left">St Etienne</td>
<td class="org-left">Lorient</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">D</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">nan</td>
<td class="org-right">nan</td>
</tr>

<tr>
<td class="org-left">2021-08-13 00:00:00</td>
<td class="org-left">Lorient</td>
<td class="org-left">Monaco</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">H</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">nan</td>
<td class="org-right">nan</td>
</tr>

<tr>
<td class="org-left">2021-08-22 00:00:00</td>
<td class="org-left">Montpellier</td>
<td class="org-left">Lorient</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
<td class="org-right">1</td>
<td class="org-left">H</td>
<td class="org-right">11</td>
<td class="org-right">4</td>
<td class="org-right">nan</td>
<td class="org-right">nan</td>
</tr>

<tr>
<td class="org-left">2021-08-29 00:00:00</td>
<td class="org-left">Lens</td>
<td class="org-left">Lorient</td>
<td class="org-right">4</td>
<td class="org-right">4</td>
<td class="org-right">2</td>
<td class="org-right">2</td>
<td class="org-left">D</td>
<td class="org-right">9</td>
<td class="org-right">7</td>
<td class="org-right">5</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">2021-09-10 00:00:00</td>
<td class="org-left">Lorient</td>
<td class="org-left">Lille</td>
<td class="org-right">5</td>
<td class="org-right">5</td>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-left">H</td>
<td class="org-right">7</td>
<td class="org-right">3</td>
<td class="org-right">4.33333</td>
<td class="org-right">4</td>
</tr>

<tr>
<td class="org-left">2021-09-19 00:00:00</td>
<td class="org-left">Reims</td>
<td class="org-left">Lorient</td>
<td class="org-right">6</td>
<td class="org-right">6</td>
<td class="org-right">0</td>
<td class="org-right">0</td>
<td class="org-left">D</td>
<td class="org-right">2</td>
<td class="org-right">3</td>
<td class="org-right">3.33333</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-left">2021-09-22 00:00:00</td>
<td class="org-left">Lorient</td>
<td class="org-left">Nice</td>
<td class="org-right">7</td>
<td class="org-right">6</td>
<td class="org-right">1</td>
<td class="org-right">0</td>
<td class="org-left">H</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">5.66667</td>
<td class="org-right">3.66667</td>
</tr>

<tr>
<td class="org-left">2021-09-25 00:00:00</td>
<td class="org-left">Lyon</td>
<td class="org-left">Lorient</td>
<td class="org-right">8</td>
<td class="org-right">8</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">D</td>
<td class="org-right">2</td>
<td class="org-right">5</td>
<td class="org-right">6.66667</td>
<td class="org-right">3.66667</td>
</tr>

<tr>
<td class="org-left">2021-10-03 00:00:00</td>
<td class="org-left">Lorient</td>
<td class="org-left">Clermont</td>
<td class="org-right">9</td>
<td class="org-right">9</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">D</td>
<td class="org-right">1</td>
<td class="org-right">4</td>
<td class="org-right">3</td>
<td class="org-right">3</td>
</tr>

<tr>
<td class="org-left">2021-10-17 00:00:00</td>
<td class="org-left">Marseille</td>
<td class="org-left">Lorient</td>
<td class="org-right">9</td>
<td class="org-right">10</td>
<td class="org-right">4</td>
<td class="org-right">1</td>
<td class="org-left">H</td>
<td class="org-right">6</td>
<td class="org-right">7</td>
<td class="org-right">2.66667</td>
<td class="org-right">2.33333</td>
</tr>
</tbody>
</table>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Pourquoi les 3 premières valeurs des colonnes <code>HSHT_MA3</code> et <code>ASHT_MA3</code> valent <code>nan</code> ?</li>
<li>Vérifier que la valeur de l'indicateur <code>ASHT_MA3</code> est correct en date du 29/08/2021.</li>
<li>Calculer la valeur de l'indicateur de tirs cadrés moyen sur les 3 derniers matchs pour Lorient
lors de sa 11ème journée.</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-sec:odds_df" class="outline-2">
<h2 id="sec:odds_df"><span class="section-number-2">3.</span> Données de cotes</h2>
<div class="outline-text-2" id="text-sec:odds_df">
</div>

<div id="outline-container-org7782204" class="outline-3">
<h3 id="org7782204"><span class="section-number-3">3.1.</span> Rappels</h3>
<div class="outline-text-3" id="text-3-1">
<p>
La notion de cote possède plusieurs définitions. Voici deux formulations usuelles qui sont en fait
toutes deux liées :
</p>
<ul class="org-ul">
<li>En probabilité, la cote, notée \(g_{E}\), associée à l'occurrence d'un événement \(E\) est défini par
le rapport des probabilités suivantes : 
\[
  g_{E} = \frac{\text{Prob}(\text{l'évenement $E$ ne se réalise pas})}{\text{Prob}(\text{l'événement
  $E$ se réalise})},
  \]
que l'on peut réécrire comme suit :
\[
  g_{E} = \frac{1 - p_{E}}{p_{E}} = \frac{1}{p_{E}} - 1,
  \]
en notant \(p_{E} = \text{Prob}(\text{l'événement E se réalise})\).</li>
<li><p>
Dans le monde des bookmakers, la cote associée à l'occurrence d'un événement \(E\) est notée \(c_{E}\)
et a pour expression :
</p>
\begin{equation}
\label{org3fdd706}
c_{E} = \frac{1}{p_{E}}.
\end{equation}
<p>
On a donc la relation \(c_{E} = g_{E} + 1\) permettant de relier les deux notions de cotes.
</p></li>
</ul>

<p>
Les données des cotes disponibles dans ce TD sont donc sous la forme \eqref{org3fdd706}.
</p>
</div>
</div>

<div id="outline-container-org48c06ce" class="outline-3">
<h3 id="org48c06ce"><span class="section-number-3">3.2.</span> Présentation des données</h3>
<div class="outline-text-3" id="text-3-2">
<p>
Les données de cotes, référencées dans la suite par données <code>odds</code>, contiennent les cotes proposées
 par le bookmaker B365 pour le pari "inférieur/supérieur à 2.5 buts" pour un historique de matchs
 de football masculin. Le Tableau  <a href="#orgad325ab">3</a> présente une description succinctes des
 variables présentes. 
</p>

<table id="orgad325ab" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Tableau 3 :</span> Définition des variables du jeu de données <code>odds</code>.</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Colonne</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">league_id</td>
<td class="org-left">Identifiant du championnat</td>
</tr>

<tr>
<td class="org-left">season_id</td>
<td class="org-left">Identifiant de la saison</td>
</tr>

<tr>
<td class="org-left">Date</td>
<td class="org-left">Date du match au format %Y-%m-%d</td>
</tr>

<tr>
<td class="org-left">HTeam</td>
<td class="org-left">Équipe à domicile (ED)</td>
</tr>

<tr>
<td class="org-left">ATeam</td>
<td class="org-left">Équipe à l'exterieur (EE)</td>
</tr>

<tr>
<td class="org-left">NGFT2.5</td>
<td class="org-left">Événement : '&lt;2.5' : 2 buts ou moins ont été inscrits dans le match'&gt;2.5' : au moins 3 buts ont été inscrits dans le match</td>
</tr>

<tr>
<td class="org-left">odds</td>
<td class="org-left">Cote de l'événement</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org581a56a" class="outline-3">
<h3 id="org581a56a"><span class="section-number-3">3.3.</span> Chargement des données</h3>
<div class="outline-text-3" id="text-3-3">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Charger les données depuis le lien 
<a href="https://roland-donat.github.io/ubs-lpmds-python/td/data/odds_bis.csv.bz2">https://roland-donat.github.io/ubs-lpmds-python/td/data/odds_bis.csv.bz2</a> et stocker les dans un
<code>DataFrame</code> nommé <code>odds_df</code> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #F0DFAF; font-weight: bold;">import</span> pandas <span style="color: #F0DFAF; font-weight: bold;">as</span> pd

<span style="color: #DFAF8F;">odds_url</span> = <span style="color: #CC9393;">"https://roland-donat.github.io/ubs-lpmds-python/td/data/odds_bis.csv.bz2"</span>
<span style="color: #DFAF8F;">odds_df</span> = pd.read_csv(odds_url, sep=<span style="color: #CC9393;">";"</span>, compression=<span style="color: #CC9393;">"bz2"</span>)
</pre>
</div></li>

<li><p>
Réaliser les opérations de typage adéquates :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">col_cats</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"NGFT2.5"</span>]
<span style="color: #F0DFAF; font-weight: bold;">for</span> col <span style="color: #F0DFAF; font-weight: bold;">in</span> col_cats:
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> <span style="color: #DFAF8F;">odds_df</span>[col] = odds_df[col].astype(<span style="color: #CC9393;">"category"</span>)

<span style="color: #DFAF8F;">odds_df</span>[<span style="color: #CC9393;">"Date"</span>] = odds_df[<span style="color: #CC9393;">"Date"</span>].astype(<span style="color: #CC9393;">"datetime64[ns]"</span>)
</pre>
</div></li>
</ol>
</div>
</div>
</div>


<div id="outline-container-org8a19b95" class="outline-2">
<h2 id="org8a19b95"><span class="section-number-2">4.</span> Modélisation décisionnelle</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orga204132" class="outline-3">
<h3 id="orga204132"><span class="section-number-3">4.1.</span> Généralité</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Dans le cadre de ce TD, nous proposons de réaliser des pronostics sur le nombre total des buts
inscrits lors d'une rencontre. Afin de simplifier la problématique, nous cherchons uniquement à
déterminer si le nombre de buts inscrit est inférieur ou supérieur à 2.
</p>

<p>
D'un point de vue probabiliste, on note <code>NGFT2.5</code>, la variable aléatoire représentant le nombre de
buts inscrit sur une rencontre discrétisée au seuil de 2.5 buts. Il s'agit donc d'une variable
binaire ayant pour valeurs <code>&lt;2.5</code> ou <code>&gt;2.5</code>.
</p>

<p>
La variable <code>NGFT2.5</code> est appelée variable cible ou variable à expliquer du problème
décisionnel. L'objectif est alors de prévoir/pronostiquer les valeurs de la variable cible à partir 
d'observations de variables disponibles. Ces variables observées sont appelées variables
explicatives.
</p>

<p>
Formellement, notre problème de pronostic revient alors à estimer la probabilité
</p>
\begin{equation}
\label{org2da0006}
P(\text{NGFT2.5} = \text{<2.5} | X_{1} = x_{1}, \ldots, X_{n} = x_{n})
\end{equation}
<p>
où \(x_{1}, \ldots, x_{n}\) sont des observations des variables explicatives \(X_{1}, \ldots,
X_{n}\) que nous avons choisi d'utiliser dans nos pronostics. L'estimation de cette probabilité est
réalisée en pratique à partir des données disponibles pour lesquelles on observe à la fois la
variable cible et les variables explicatives. Cependant, l'estimation empirique directe de cette
probabilité s'avère souvent difficile d'un point de vue informatique, soit par manque de données,
soit parce que le calcul n'est pas réalisable en un temps raisonnable.
</p>

<p>
Pour contourner ce problème, on approche la probabilité \eqref{org2da0006} par une fonction plus
simple à calculer. Cette fonction est également appelée modèle décisionnel, par exemple, le modèle
de régression logistique utilise la fonction \(\text{logit}\). 
</p>

<p>
En notant \(\hat{p}_{\text{<2.5}}(x_{1}, \ldots, x_{n})\) l'estimation de la probabilité
\eqref{org2da0006} obtenue par le modèle décisionnel utilisé, nous pouvons déduire la règle de 
décision \(\text{R}_{\text{NGFT2.5}}\) générale suivante :
</p>
\begin{equation}
\text{R}_{\text{NGFT2.5}}(x_{1}, \ldots, x_{n}) =
\begin{cases}
\text{<2.5} & \text{si}~ \hat{p}_{\text{<2.5}}(x_{1}, \ldots, x_{n}) > \delta, \\
\text{>2.5} & \text{sinon},
\end{cases}
\end{equation}
<p>
où \(\delta \in [0, 1]\) est appelé seuil de décision. Il est courant de poser dans un premier temps
\(\delta = 0.5\). Toutefois, le seuil de décision est un paramètre fondamental du processus de
décision qui peut notamment être optimisé en fonction :
</p>
<ul class="org-ul">
<li>des conséquences occasionnées par les erreurs de pronostic et des récompenses induites par les
bons pronostics ;</li>
<li>la probabilité <i>a priori</i> d'observer plus ou moins de 2.5 buts.</li>
</ul>

<p>
Enfin, voici deux précisions en termes de vocabulaire :
</p>
<ul class="org-ul">
<li>lorsque l'objectif du problème décisionnel est de prédire/pronostiquer/prévoir/expliquer une
variable cible de nature catégorielle, on parle de problème de <b>classification</b>.</li>
<li>lorsque l'on dispose de données dans lesquelles on observe à la fois les variables explicatives et
la variable cible, on parle de problème <b>supervisé</b>.</li>
</ul>

<p>
Par conséquent, nous sommes dans le cadre de ces TD face à un problème de <b>classification
supervisée</b>.
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Ajouter au <code>DataFrame</code> <code>fixtures_df</code> une nouvelle variable <code>NGFT</code> contenant le nombre de buts
inscrits lors de chaque rencontre.</li>
<li><p>
Créer ensuite la variable <code>NGFT2.5</code> en discrétisant la variable <code>NGFT</code> sur les ensembles
\([0, 2.5[\) et \([2.5, \infty[\) à l'aide de la fonction <code>pd.cut</code> :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"NGFT2.5"</span>] = pd.cut(fixtures_df[<span style="color: #CC9393;">"NGFT"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   bins=[0, 2.5, <span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>)])
</pre>
</div>
<p>
Le paramètre <code>bins</code> permet de spécifier les bornes des intervalles de discrétisation. Observer le
résultat de la discrétisation, quel est le type de la <code>Series</code> obtenue ? Le résultat est-il
conforme à l'attendu ?
</p>

<p>
Il est important de remarquer que la fonction <code>pd.cut</code> crée des intervalles ouverts à gauche et fermés à
droite. Il faut donc être vigilant en fixant les bornes de discrétisation en s'assurant en
particulier que les observations égales aux bornes ne soient pas exclues ou placées dans un
intervalle de discrétisation incorrect.
</p>

<p>
Pour corriger le problème, discrétiser la variable <code>NGFT</code> sur les ensembles
\([-\infty, 2.5[\) et \([2.5, \infty[\) à l'aide de la fonction <code>pd.cut</code> : 
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"NGFT2.5"</span>] = pd.cut(fixtures_df[<span style="color: #CC9393;">"NGFT"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   bins=[-<span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>), 2.5, <span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>)])
</pre>
</div>

<p>
Enfin, la fonction <code>pd.cut</code> permet de discrétiser une variable en labellisant les intervalles de
discrétisation. Par exemple, pour associer le label <code>&lt;2.5</code> à l'intervalle \([-\infty, 2.5[\) et le
label <code>&gt;2.5</code> à l'intervalle \([2.5, \infty[\), il faut écrire :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">fixtures_df</span>[<span style="color: #CC9393;">"NGFT2.5"</span>] = pd.cut(fixtures_df[<span style="color: #CC9393;">"NGFT"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   bins=[-<span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>), 2.5, <span style="color: #DCDCCC; font-weight: bold;">float</span>(<span style="color: #CC9393;">"inf"</span>)],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   labels=[<span style="color: #CC9393;">"&lt;2.5"</span>, <span style="color: #CC9393;">"&gt;2.5"</span>])
</pre>
</div></li>

<li>Représenter graphiquement l'évolution de la proportion de match à plus de 2.5 buts au fil des saisons, et
ce, pour chaque championnat. Utiliser <code>px.line</code> pour construire le diagramme en lignes
correspondant en affichant une ligne de couleur différente par championnat.</li>
<li>Donner des exemples de variables explicatives directement disponibles dans les données <code>fixtures</code>
que vous pourriez utiliser pour pronostiquer les événements "plus ou moins de 2.5 buts dans un match".</li>

<li>Dans le cadre d'un pari sportif, quelle est la conséquence d'un mauvais pronostic et quel est le
bénéfice d'un pronostic correct ?</li>
</ol>
</div>
</div>

<div id="outline-container-org3c184c7" class="outline-3">
<h3 id="org3c184c7"><span class="section-number-3">4.2.</span> Modèle empirique <i>a priori</i></h3>
<div class="outline-text-3" id="text-4-2">
<p>
Le modèle empirique <i>a priori</i> consiste à ne pas tenir compte de variables explicatives dans le
processus décisionnel.
</p>

<p>
Le modèle décisionnel se formule donc simplement :
</p>
\begin{equation}
P(\text{NGFT2.5} = \text{<2.5}) \simeq \hat{p}_{\text{<2.5}} = \hat{P}(\text{NGFT2.5} = \text{<2.5})
\end{equation}
<p>
où \(\hat{P}(\text{NGFT2.5} = \text{<2.5})\) est la probabilité empirique de l'événement \(\{\text{NGFT2.5} = \text{<2.5}\}\).
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Estimer la probabilité empirique \(\hat{P}(\text{NGFT2.5} = \text{<2.5})\) à partir des données disponibles.</li>
<li><p>
En fixant la règle de pronostic suivante :
</p>
\begin{equation}
\text{R}_{\text{NGFT2.5}} =
\begin{cases}
\text{<2.5} & \text{si}~ \hat{P}(\text{NGFT2.5} = \text{<2.5}) > \delta, \\
\text{>2.5} & \text{sinon},
\end{cases}
\end{equation}

<p>
Quels seront vos pronostics avec \(\delta = 0.5\) ?
</p></li>

<li>Que deviennent les pronostics si on pose \(\delta = 0.4\).</li>

<li>Évaluer le pourcentage de bons pronostics sur les données disponibles en utilisant la règle de
décision avec \(\delta = 0.5\) et \(\delta = 0.4\). À quoi ressemble le graphique du pourcentage de
bons pronostics en fonction de \(\delta\) sur les données disponibles.</li>
</ol>
</div>
</div>

<div id="outline-container-sec:model_emp_hsht_ma3d" class="outline-3">
<h3 id="sec:model_emp_hsht_ma3d"><span class="section-number-3">4.3.</span> Modèle empirique <code>HSHT_MA3</code></h3>
<div class="outline-text-3" id="text-sec:model_emp_hsht_ma3d">
<p>
Dans cette section, nous considérons le modèle empirique de pronostic de la variable <code>NGFT2.5</code>
tenant compte de la variable explicative <code>HSHT_MA3</code> uniquement.
</p>

<p>
Le modèle décisionnel s'écrit alors comme suit :
</p>
\begin{equation}
P(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3} = x) \simeq \hat{p}_{\text{<2.5}}(x) = \hat{P}(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3} = x)
\end{equation}
<p>
où \(\hat{P}(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3} = x)\) est la probabilité conditionnelle
empirique de l'événement \(\{\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3} = x\}\).
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Remarquons tout d'abord que la variable <code>HSHT_MA3</code> est une variable continue ce qui n'est pas
pratique pour estimer la probabilité conditionnelle empirique \(\hat{P}(\text{NGFT2.5} =
   \text{<2.5} | \text{HSHT_MA3} = x)\). Nous proposons de simplifier le problème en discrétisant la
variable <code>HSHT_MA3</code>.
</p>

<p>
Créer une nouvelle variable <code>HSHT_MA3d</code> correspondant à la discrétisation de la variable
<code>HSHT_MA3d</code> sur les intervalles \(]-\infty, 3]\), \(]3, 6]\), \(]6, \infty[\).
</p></li>
<li><p>
Estimer la probabilité conditionnelle empirique \(\hat{P}(\text{NGFT2.5} |
   \text{HSHT_MA3d})\) à partir des données disponibles et stocker le résultat dans un <code>DataFrame</code>
<code>model_hsht_ma3d_df</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">model_hsht_ma3d_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_df.groupby([<span style="color: #CC9393;">"HSHT_MA3d"</span>])[<span style="color: #CC9393;">"NGFT2.5"</span>]\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .value_counts(normalize=<span style="color: #BFEBBF;">True</span>)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .unstack()
model_hsht_ma3d_df
</pre>
</div></li>

<li><p>
En déduire la règle de pronostic pour \(\delta = 0.5\). La règle de pronostic est attendue sous la
forme d'une <code>Series</code>, nommée <code>rd_hsht_ma3d_50</code>, ayant pour index les valeurs possibles de la variable <code>HSHT_MA3d</code> et pour
valeurs les pronostics associés (<code>&lt;2.5</code> ou <code>&gt;2.5</code>). Assigner à l'attribut <code>name</code> de la <code>Series</code>
obtenue le label <code>"NGFT2.5_pred_50"</code>.
</p>

<p>
<b>Aide</b> : Importer <code>numpy</code> (<code>import numpy as np</code>) et consulter l'aide de la méthode <code>np.where</code>.
</p></li>
<li><p>
Utiliser la règle de décision précédente (\(\delta = 0.5\)) afin de pronostiquer la variable
<code>NGFT2.5</code> sur les données disponibles. Le résultat attendu est une <code>Series</code> ayant pour index les
variables permettant d'identifier un match de manière unique et pour valeurs le résultat du
pronostic de chaque match.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">var_fixture_id</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"Date"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>]
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   
<span style="color: #DFAF8F;">model_hsht_ma3d_pred_50</span> = fixtures_df.set_index(<span style="color: #CC9393;">"HSHT_MA3d"</span>)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .join(rd_hsht_ma3d_50)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .set_index(var_fixture_id)[<span style="color: #CC9393;">"NGFT2.5_pred_50"</span>]
model_hsht_ma3d_pred_50
</pre>
</div>
<p>
La méthode <code>.join</code> permet par défaut de faire une jointure à gauche entre le <code>DataFrame</code> qui
appelle la méthode et un <code>DataFrame</code> ou une <code>Serie</code> partageant le même index (c'est-à-dire des
lignes ayant des noms en commun).
Ceci explique pourquoi on commence par réindexer <code>fixtures_df</code> avec la variable <code>HSHT_MA3d</code> afin
de partager le même index que la <code>Series</code> <code>rd_hsht_ma3d_50</code>. Après la jointure, on change l'index
avec les variables permettant d'identifier sans ambiguïté un match.
</p></li>

<li><p>
Calculer la matrice de confusion des pronostics réalisés précédemment :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">ct_hsht_ma3d_pred_50</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   pd.crosstab(fixtures_df.set_index(var_fixture_id)[<span style="color: #CC9393;">"NGFT2.5"</span>],
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   model_hsht_ma3d_pred_50)
ct_hsht_ma3d_pred_50
</pre>
</div>
<p>
Interpréter le tableau obtenu.
</p></li>

<li>En déduire le pourcentage de bons pronostics de la règle de décision avec \(\delta = 0.5\).</li>
<li>Appliquer de nouveau les traitements précédents en utilisant le seuil de décision \(\delta =
   0.52\).</li>
<li>Analyser les résultats et comparer les caractéristiques des deux règles de pronostic mises
en oeuvre précédemment. Selon vous, quelle règle est la plus pertinente pour un parieur ?</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org5b1eafd" class="outline-2">
<h2 id="org5b1eafd"><span class="section-number-2">5.</span> Évaluation des performances</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orge1feaad" class="outline-3">
<h3 id="orge1feaad"><span class="section-number-3">5.1.</span> Données d'apprentissage et de test</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Dans la section précédente, nous avons élaboré deux modèles décisionnelles et testé différentes
règles de décision. Nous avons ensuite évalué nos modèles en calculant le pourcentage de bons
pronostics à partir des données disponibles.
</p>

<p>
Cette démarche souffre malheureusement de deux défauts majeurs :
</p>
<ol class="org-ol">
<li>Nous avons ajusté nos modèles avec les mêmes données qui nous ont servi à leur évaluation. Or,
dans une situation réelle, nous ne pouvons pas utiliser les données des matchs que nous voulons
pronostiquer pour construire nos modèles.</li>
<li>Évaluer la performance de nos modèles en s'intéressant uniquement aux bons pronostics n'est pas
une méthode pertinente dans le cas des paris sportifs. En effet, le "score" d'un bon pronostic
dépend de la cote associée. Il faut donc impérativement tenir compte des cotes de chaque pari
dans l'évaluation d'un modèle sous peine d'aboutir à des résultats largement optimistes.</li>
</ol>


<p>
Afin de palier le point 1), l'approche adéquate consiste à séparer les données disponibles en deux
échantillons : 
</p>
<ol class="org-ol">
<li>un échantillon, dit d'<b>apprentissage</b>, servant à ajuster les paramètres du modèle ;</li>
<li>un échantillon, dit de <b>test</b>, sur lequel nous allons évaluer les performances prédictives du
modèle.</li>
</ol>

<p>
La proportion entre données d'apprentissage et données de test est usuellement de 2/3, 1/3 mais tout
dépend en pratique de l'application considérée.  
</p>

<p>
<b>Note :</b> dans les problématiques où les données dépendent du temps (comme c'est le cas pour les
pronostics sportifs), il est important de veiller à ce que les données d'apprentissage soient bien
antérieures aux données de test.
</p>

<p>
<b>Travail à réaliser :</b> 
</p>
<ol class="org-ol">
<li><p>
Créer un échantillon d'apprentissage <code>fixtures_train_df</code> en prenant les rencontres ayant eu lieu
avant la saison <code>2019-2020</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">idx_train</span> = fixtures_df[<span style="color: #CC9393;">"season_id"</span>].astype(<span style="color: #DCDCCC; font-weight: bold;">str</span>) &lt; <span style="color: #CC9393;">"2019-2020"</span>
<span style="color: #DFAF8F;">fixtures_train_df</span> = fixtures_df.loc[idx_train]
</pre>
</div></li>

<li>Créer l'échantillon de test <code>fixtures_test_df</code> en prenant le reste des données, à savoir les
matchs ayant eu lieu lors de la saison <code>2019-2020</code> et après.</li>
</ol>
</div>
</div>
<div id="outline-container-orgffba23d" class="outline-3">
<h3 id="orgffba23d"><span class="section-number-3">5.2.</span> Apprentissage des modèles</h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-orgc4bf604" class="outline-4">
<h4 id="orgc4bf604"><span class="section-number-4">5.2.1.</span> Modèle empirique <code>HSHT_MA3d</code></h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
Il s'agit de reprendre le modèle décisionnel construit en Section <a href="#sec:model_emp_hsht_ma3d">4.3</a>, à
savoir pour rappel :
</p>
\begin{equation}
P(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3d} = x) \simeq \hat{P}(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3d} = x)
\end{equation}
<p>
avec \(x \in \{]-\infty, 3], ]3, 6], ]6, \infty[\}\). 
</p>

<p>
Cependant, nous allons cette fois-ci estimer les probabilités conditionnelles empiriques
\(\hat{P}(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3} = x)\) à partir des données d'apprentissage
uniquement. 
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Estimer la probabilité conditionnelle empirique \(\hat{P}(\text{NGFT2.5} |
   \text{HSHT_MA3d})\) à partir des données d'apprentissage et stocker le résultat dans un <code>DataFrame</code>
<code>model_hsht_ma3d_train_df</code></li>
</ol>
</div>
</div>
<div id="outline-container-org789a31f" class="outline-4">
<h4 id="org789a31f"><span class="section-number-4">5.2.2.</span> Modèle empirique <code>HSHT_ASHT_MA3d</code></h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
Nous proposons d'améliorer le modèle précédent en tenant également du nombre de tirs cadrés moyen
sur les trois dernier match de l'équipe à l'extérieur. Nous obtenons le modèle empirique suivant :
</p>
\begin{align}
P(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3d} = x_{1}, \text{ASHT_MA3d} = x_{2}) & \\
 \simeq \hat{P}(\text{NGFT2.5} = \text{<2.5} | \text{HSHT_MA3d} = x_{1}, \text{ASHT_MA3d} = x_{2}) &
\end{align}
<p>
avec \(x_{1}, x_{2} \in \{]-\infty, 3], ]3, 6], ]6, \infty[\}\). 
</p>

<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Créer une nouvelle variable <code>ASHT_MA3d</code> dans les <code>DataFrame</code> <code>fixtures_train_df</code> et
<code>fixtures_test_df</code> correspondant à la discrétisation de la variable
<code>ASHT_MA3</code> sur les intervalles \(]-\infty, 3]\), \(]3, 6]\), \(]6, \infty[\).</li>
<li>Estimer la probabilité conditionnelle empirique \(\hat{P}(\text{NGFT2.5} |
   \text{HSHT_MA3d}, \text{ASHT_MA3d})\) à partir des données d'apprentissage et stocker le résultat dans un <code>DataFrame</code>
<code>model_hsht_asht_ma3d_train_df</code></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org2378ebd" class="outline-3">
<h3 id="org2378ebd"><span class="section-number-3">5.3.</span> Évaluation des modèles</h3>
<div class="outline-text-3" id="text-5-3">
</div>
<div id="outline-container-org6ddf959" class="outline-4">
<h4 id="org6ddf959"><span class="section-number-4">5.3.1.</span> Modèle empirique <code>HSHT_MA3d</code></h4>
<div class="outline-text-4" id="text-5-3-1">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li><p>
Pronostiquer la variable <code>NGFT2.5</code> sur les données de test en utiliser le modèle empirique
<code>HSHT_MA3d</code> avec un seuil de décision \(\delta = 0.5\).
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">delta</span> = 0.5
<span style="color: #DFAF8F;">var_fixture_id</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"Date"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>]

<span style="color: #DFAF8F;">rd_hsht_ma3d_train_50</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   pd.Series(np.where(model_hsht_ma3d_train_df[<span style="color: #CC9393;">"&lt;2.5"</span>] &gt; delta, <span style="color: #CC9393;">"&lt;2.5"</span>, <span style="color: #CC9393;">"&gt;2.5"</span>),
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> index=model_hsht_ma3d_train_df.index,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span> name=<span style="color: #CC9393;">"NGFT2.5_pred_50"</span>)
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   
<span style="color: #DFAF8F;">model_hsht_ma3d_pred_test_50</span> = fixtures_test_df.set_index(<span style="color: #CC9393;">"HSHT_MA3d"</span>)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .join(rd_hsht_ma3d_train_50)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .set_index(var_fixture_id)[<span style="color: #CC9393;">"NGFT2.5_pred_50"</span>]
model_hsht_ma3d_pred_test_50
</pre>
</div></li>

<li>Calculer la matrice de confusion et le taux de bons pronostics obtenu :</li>
<li><p>
Créer un nouveau <code>DataFrame</code> <code>fixtures_test_odds_df</code> en effectuant une jointure à droite entre les
<code>DataFrame</code> <code>fixtures_test_df</code> et <code>odds_df</code> afin d'obtenir la cote associée aux
valeurs de la variable <code>NGFT_2.5</code> pour chacune des rencontres :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">var_odds_id</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"Date"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>, <span style="color: #CC9393;">"NGFT2.5"</span>]

<span style="color: #DFAF8F;">fixtures_test_odds_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_df.set_index(var_odds_id)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .join(odds_df.set_index(var_odds_id))\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .dropna()\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .reset_index()
</pre>
</div></li>

<li><p>
Créer un <code>DataFrame</code> <code>model_perf_hsht_ma3d_test_50_df</code> contenant :
</p>
<ul class="org-ul">
<li>les variables <code>["league_id", "season_id", "Date", "HTeam", "ATeam"]</code> en index ;</li>
<li>les variables <code>["NGFT2.5", "NGFT2.5_pred_50", "odds"]</code> en colonne.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">var_fixtures_id</span> = [<span style="color: #CC9393;">"league_id"</span>, <span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"Date"</span>, <span style="color: #CC9393;">"HTeam"</span>, <span style="color: #CC9393;">"ATeam"</span>]
<span style="color: #DFAF8F;">var_pred</span> = [<span style="color: #CC9393;">"NGFT2.5"</span>, <span style="color: #CC9393;">"NGFT2.5_pred_50"</span>, <span style="color: #CC9393;">"odds"</span>]
<span style="color: #DFAF8F;">model_perf_hsht_ma3d_test_50_df</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   fixtures_test_odds_df.set_index(var_fixtures_id)\
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   .join(model_hsht_ma3d_pred_test_50)[var_pred]
model_perf_hsht_ma3d_test_50_df
</pre>
</div></li>

<li><p>
Ajouter une colonne <code>score</code> au <code>DataFrame</code> <code>model_perf_hsht_ma3d_test_50_df</code> contenant, pour
chaque rencontre :
</p>
<ul class="org-ul">
<li>la valeur de la colonne <code>odds</code> - 1 si le pronostic du modèle est correct ;</li>
<li>-1 sinon.</li>
</ul>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">idx_pronostic_ok</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   model_perf_hsht_ma3d_test_50_df[<span style="color: #CC9393;">"NGFT2.5"</span>] == model_perf_hsht_ma3d_test_50_df[<span style="color: #CC9393;">"NGFT2.5_pred_50"</span>]
<span style="color: #DFAF8F;">model_perf_hsht_ma3d_test_50_df</span>[<span style="color: #CC9393;">"score"</span>] = model_perf_hsht_ma3d_test_50_df[<span style="color: #CC9393;">"odds"</span>] - 1
<span style="color: #DFAF8F;">model_perf_hsht_ma3d_test_50_df.loc</span>[~idx_pronostic_ok, <span style="color: #CC9393;">"score"</span>] = -1
</pre>
</div></li>

<li><p>
En déduire la performance du modèle décisionnel empirique <code>HSHT_MA3d</code> évaluée sur les données de
test considérée. Doit-on faire nos valises et partir profiter de la vie sous le soleil du
Finistère Sud ? 
</p>
<div class="org-src-container">
<pre class="src src-python">model_perf_hsht_ma3d_test_50_df[<span style="color: #CC9393;">"score"</span>].<span style="color: #DCDCCC; font-weight: bold;">sum</span>()
</pre>
</div></li>

<li><p>
Représenter graphiquement la performance moyenne du modèle par saison et
par championnat.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #DFAF8F;">model_perf_hsht_ma3d_test_50_avg</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   model_perf_hsht_ma3d_test_50_df.groupby([<span style="color: #CC9393;">"season_id"</span>, <span style="color: #CC9393;">"league_id"</span>])[<span style="color: #CC9393;">"score"</span>].mean()

<span style="color: #DFAF8F;">fig</span> = \
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   px.bar(model_perf_hsht_ma3d_test_50_avg.reset_index(),
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  x=<span style="color: #CC9393;">"season_id"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  y=<span style="color: #CC9393;">"score"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  color=<span style="color: #CC9393;">"league_id"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  title=<span style="color: #CC9393;">"Performances du mod&#232;le empirique HSHT_MA3d"</span>,
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  labels={<span style="color: #CC9393;">"season_id"</span>: <span style="color: #CC9393;">"Saison"</span>, <span style="color: #CC9393;">"score"</span>: <span style="color: #CC9393;">"Score"</span>, <span style="color: #CC9393;">"league_id"</span>: <span style="color: #CC9393;">"Championnat"</span>},
<span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>   <span style="color: #DCDCCC; background-color: #4F4F4F;"> </span>  barmode=<span style="color: #CC9393;">"group"</span>)
fig
</pre>
</div></li>

<li>Selon vous, comment pourrait-on améliorer la performance de nos pronostics ?</li>
</ol>
</div>
</div>

<div id="outline-container-orge8ef4d1" class="outline-4">
<h4 id="orge8ef4d1"><span class="section-number-4">5.3.2.</span> Modèle empirique <code>HSHT_ASHT_MA3d</code></h4>
<div class="outline-text-4" id="text-5-3-2">
<p>
<b>Travail à réaliser :</b>
</p>
<ol class="org-ol">
<li>Évaluer le modèle empirique <code>HSHT_ASHT_MA3d</code> en reprenant la procédure mise en oeuvre dans la
section précédente.</li>
<li>Comparer les performances obtenues avec celles du modèle empirique <code>HSHT_MA3d</code>.</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
